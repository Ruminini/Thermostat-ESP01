<!DOCTYPE html>
<html>
<head>
	<title>ESP-01 Thermostat</title>
</head>
<body>
	<h1>ESP-01 Thermostat</h1>
	<p>Temperature: <span id='temperature'></span>&#8451;</p>
	<p>Humidity: <span id='humidity'></span>%</p>
	<p>Relay State: <span id='relayState'></span></p>
	<label for="force">Force</label>
	<input onclick='toggleForce()' type="checkbox" id="force">
	<button id="relay" onclick='toggleRelay()'>On</button>
	<label for="targetTemp">Target Temperature: <span id="targetTempValue">20</span></label>
	<input type="range" id="targetTemp" min="15" max="30" step="1" value="20" oninput="updateValue('targetTemp')">
	<label for="hysteresis">Hysteresis: <span id="hysteresisValue">2</span></label>
	<input type="range" id="hysteresis" min="0" max="10" step="1" value="2" oninput="updateValue('hysteresis')">
	<label for="updatePeriod">Update Period: <span id="updatePeriodValue">300</span>ms</label>
	<input type="range" id="updatePeriod" min="15000" max="600000" step="15000" value="300000" oninput="updateValue('updatePeriod')">
	<script>
		function toggleForce() {
			const force = document.getElementById('force').checked;
			document.getElementById('relay').disabled = !force;
			document.getElementById('targetTemp').disabled = force;
			document.getElementById('hysteresis').disabled = force;
			document.getElementById('updatePeriod').disabled = force;
			toggleRelay(force ? relay == 'ON' ? 1 : 0 : -1);
		}
		let relay = 'OFF';
		let updateForm = true;
		function toggleRelay(state = relay == 'ON' ? 0 : 1) {
			fetch('/set?relay=' + state, { method: 'POST' }).then(fetchData);
		}
		let debounceTimer;
		function updateValue(id) {
				const element = document.getElementById(id);
				const valueElement = document.getElementById(id + 'Value');
				valueElement.textContent = element.value;
				clearTimeout(debounceTimer);
				debounceTimer = setTimeout(() => {
					fetch('/set?' + id + '=' + element.value, { method: 'POST' });
					fetchData();
				}, 500);
		}
		function fetchData() {
			fetch('/data').then(response => response.json()).then(data => {
				relay = data.relay == 0 ? 'OFF' : 'ON';
				document.getElementById('temperature').innerText = data.temperature;
				document.getElementById('humidity').innerText = data.humidity;
				document.getElementById('relayState').innerText = relay;
				document.getElementById('relay').innerText = relay;
				document.getElementById('targetTemp').value = data.targetTemp;
				document.getElementById('hysteresis').value = data.hysteresis;
				document.getElementById('updatePeriod').value = data.updatePeriod;
				document.getElementById('targetTempValue').textContent = data.targetTemp;
				document.getElementById('hysteresisValue').textContent = data.hysteresis;
				document.getElementById('updatePeriodValue').textContent = data.updatePeriod;
			});
		}
		setInterval(fetchData, 5000);
		fetchData();
		toggleForce();
	</script>
</body>
</html>